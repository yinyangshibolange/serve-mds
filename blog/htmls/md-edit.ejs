<html>
<head>

    <link rel="stylesheet" href="/css/modules/md-edit.css">
    <title>文章编辑</title>
    <link rel="stylesheet" href="css/editormd.min.css">

    <script src ="/plugins/switch/index.min.js"></script>
</head>

<body>

    <section id="typeLeft" class="scroll-999">
        <div class="flex">
            <a class="add-type add-type-top" data-type="">+添加分类</a>
            <a class="add-md add-type-top" data-type="" href="/md-edit.html">+添加文章</a>
        </div>
        <div class="md-menu">
            <%- editMenu %>
        </div>
    </section>

   <section id="typeForm" class="dialog">
       <div class="dialog-mask"></div>
          <div class="dialog-content">
              <div class="dialog-header font-20">设置分类</div>
              <form action="/api/admin/postType" method="post" enctype="multipart/form-data">
                  <div class="form_item_pass">
                      <label for="type">分类名称</label>
                      <input id="type" name="type" placeholder="请输入分类名称" autocomplete="off">
                  </div>
                  <div class="form_item_pass">
                      <label for="parent">上级分类</label>
                      <input id="parent" name="parent"  readonly>
                  </div>
                  <div class="flex justify-center mt-12 ">
                      <button class="submit " type="submit">提交</button>

                  </div>
              </form>
          </div>
   </section>

    <section id="editRight">
        <form action="/api/admin/postMd" class="pd-20" method="post" enctype="multipart/form-data">
            <div class="pure-g">
                <div class="pure-u-1-2">
                    <div class="form_item_pass">
                        <label for="title">标题</label>
                        <input id="title" class="flex-1" name="title" placeholder="请输入标题" autocomplete="off" value="<%- mdObj.title %>">
                    </div>
                </div>
                <div class="pure-u-1-2">
                    <div class="form_item_pass">
                        <label for="author">作者</label>
                        <input id="author" name="author"  placeholder="请输入作者"  value="<%- mdObj.author %>" >
                    </div>
                </div>

                <div class="pure-u-1 mt-10">
                    <div class="form_item_pass">
                        <label for="desp">描述</label>
                        <textarea id="desp" name="desp" class="flex-1" placeholder="请输入描述" rows="5">

                        </textarea>
                    </div>
                </div>


                <div class="pure-u-1-2 form_item_pass mt-10">
                    <label for="time">时间</label>
                    <input id="time" type="date" name="time"  placeholder="2023-05-20"   value="<%- mdObj.time %>">
                </div>
                <div class="pure-u-1-2 form_item_pass mt-10">
                    <label for="type">分类</label>
                    <input id="type" name="type"  placeholder=""    value="<%- type %>">
                </div>

                <div class="pure-u-1 form_item_pass mt-10">
                    <label for="tag">标签</label>
                    <input id="tag" name="tag"  placeholder="请输入描述"   value="<%- mdObj.tag %>">
                </div>

                <div class="pure-u-1 form_item_pass mt-10">
                    <label for="banner">封面</label>
                    <div id="uploadController" class="upload-image-controller">
                        <input type="file" name="banner" id="banner" accept="image/*">
                        <img id="bannerShow" src="<%- mdObj.banner %>" alt="<%- mdObj.banner %>">
                        <%- mdObj.banner ? `<input type="text" id="oldBanner" name="oldBanner" style="display: none" value="${mdObj.banner}">` : '' %>
                    </div>
                </div>

                <div class="pure-u-1-2 form_item_pass mt-10">
                    <label for="recommend">是否推荐</label>
                    <input type="checkbox" id="recommend" name="recommend" value="<%-mdObj.recommend%>" <%- mdObj.recommend ? 'checked' : '' %> style="display: none" >
                    <jelly-switch  onToggle="handleToggle('recommend')" <%- mdObj.recommend ? 'checked' : '' %>></jelly-switch>
                </div>



                <div class="pure-u-1-2 form_item_pass mt-10">
                    <label for="istop">是否置顶</label>
                    <input type="checkbox" id="istop" name="istop" value="<%-mdObj.istop%>" <%- mdObj.istop ? 'checked' : '' %>  style="display: none">
                    <jelly-switch  onToggle="handleToggle('istop')" <%- mdObj.istop ? 'checked' : '' %>></jelly-switch>
                </div>


            </div>
            <div class="mt-10 ">
                <div id="editor" ></div>
            </div>
            <button class="submit" type="submit">提交</button>

            <% if(mdObj.title){ %>
            <%- `<a href="/api/admin/deleteMd?type=${mdObj.type||''}&title=${mdObj.title||''}" type="danger">删除</a>` %>
            <% } %>
        </form>
    </section>

    <script src="js/editormd.min.js"></script>
<script>
    $(".type-li > a").click(function (ev) {
        $(this).parent().toggleClass("active")
        var next_li = $(this).parent().next()
        next_li.toggleClass("submenu-active")
    })
    $(".md-li > a").click(function (ev) {
        console.log(ev.currentTarget.dataset)
    })
    $(".add-type").click(function(ev) {
        ev.preventDefault()
        ev.stopPropagation()
        $("#typeForm").toggle()
        $("#parent").val(ev.currentTarget.dataset.type)

    })
    $("#typeForm .dialog-mask").click(function (ev) {
        ev.preventDefault()
        ev.stopPropagation()
        $("#typeForm").toggle()
    })
    var editor = editormd("editor", {
        width: "100%",
        height: "100%",
        markdown: `<% if(mdObj.content) { %><%=mdObj.content.replace(/`/g, '\\`') %><%}%>`,     // dynamic set Markdown text
        path : "/lib/" , // Autoload modules mode, codemirror, marked... dependents libs path


        imageUpload    : true,
            imageFormats   : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
        imageUploadURL : "/api/admin/upload",

    });

    $("#desp").val(`<% if(mdObj.desp) { %><%-  mdObj.desp.replace(/`/g, '\\`') %><%}%>`)

    function img2Base64(input_file, get_data) {
        /*input_file：文件按钮对象*/
        /*get_data: 转换成功后执行的方法*/
        if (typeof (FileReader) === 'undefined') {
            console.log("图片异常")
        } else {
            try {
                /*图片转Base64 核心代码*/
                var file = input_file
                //这里我们判断下类型如果不是图片就返回 去掉就可以上传任意文件
                if (!/image\/\w+/.test(file.type)) {
                    console.log("图片img2base64：转化成功");
                    return false;
                }
                var reader = new FileReader();
                reader.onload = function () {
                    get_data(this.result);
                }
                reader.readAsDataURL(file);
            } catch (e) {
                console.log("图片img2base64：转化失败")
                console.log(local_message.E_CODE_0008 + e.toString());
            }
        }
    }

    $("#banner").change(function(ev) {
        const bannerFile = $(this)[0].files[0]
        img2Base64(bannerFile, function(data) {
            $("#bannerShow").attr("src", data)
        })
        $("#uploadController #oldBanner").remove()
    })

   function handleToggle(id) {
       var event = window.event || arguments[0];
       $(`#${id}`).attr('checked', event.detail.value).val(event.detail.value)
   }

  const type =  `<%- type %>`

    const title = `<%- title %>`
let firstDom
    if(type) {
        let subType = '', typelis = $("#typeLeft .md-menu ul > li.type-li")
        type.split("-").forEach(item => {
            if(subType) {
                subType = subType + '-' + item
            } else {
                subType = item
            }
            for(let i = 0;i < typelis.length; i++) {
                    const typeli = typelis[i]
                if(typeli.dataset.type === subType) {
                    firstDom = $(typeli)[0]
                    $(typeli).addClass("active")
                    const submenuNode = $(typeli).next()
                    submenuNode.addClass("submenu-active")
                    break
                }
            }

        })
        let mdlis = $("#typeLeft .md-menu ul > li.md-li")
        for(let i = 0;i < mdlis.length; i++) {
            const mdli = mdlis[i]
            if(mdli.dataset.type === subType && mdli.dataset.title === title) {
                firstDom = $(mdli)[0]
                $(mdli).addClass("active")
                break
            }
        }


    } else {
        let mdlis = $("#typeLeft .md-menu > ul.root > li.md-li")
        for(let i = 0;i < mdlis.length; i++) {
            const mdli = mdlis[i]
            if(mdli.dataset.title === title) {
                firstDom = $(mdli)[0]
                $(mdli).addClass("active")
                break
            }
        }
    }
if(firstDom)   firstDom.scrollIntoView({ behavior: "smooth"});

</script>
</body>
</html>
