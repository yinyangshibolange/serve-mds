<html>
<head>

    <link rel="stylesheet" href="/css/modules/md-edit.css">
    <title>文章编辑</title>
    <link rel="stylesheet" href="css/editormd.min.css">

    <script src ="/plugins/switch/index.min.js"></script>
</head>

<body>

    <section id="typeLeft" class="scroll-999">
        <div class="flex">
            <a class="add-type add-type-top" data-type="">+添加分类</a>
            <a class="add-md add-type-top" data-type="">+添加文章</a>
        </div>
        <div class="md-menu">
            <%- editMenu %>
        </div>
    </section>

   <section id="typeForm" class="dialog">
       <div class="dialog-mask"></div>
          <div class="dialog-content">
              <form action="/api/admin/postType" method="post" enctype="multipart/form-data">
                  <div class="form_item_pass">
                      <label for="type">分类名称</label>
                      <input id="type" name="type" placeholder="请输入分类名称" autocomplete="off">
                  </div>
                  <div class="form_item_pass">
                      <label for="parent">上级分类</label>
                      <input id="parent" name="parent"  readonly>
                  </div>
                  <button class="submit" type="submit">提交</button>
              </form>
          </div>
   </section>

    <section id="editRight">
        <form action="/api/admin/postMd" class="pd-20" method="post" enctype="multipart/form-data">
            <div class="pure-g">
                <div class="pure-u-1-2">
                    <div class="form_item_pass">
                        <label for="title">标题</label>
                        <input id="title" class="flex-1" name="title" placeholder="请输入标题" autocomplete="off" value="<%- mdObj.title %>">
                    </div>
                </div>
                <div class="pure-u-1-2">
                    <div class="form_item_pass">
                        <label for="author">作者</label>
                        <input id="author" name="author"  placeholder="请输入作者"  value="<%- mdObj.author %>" >
                    </div>
                </div>

                <div class="pure-u-1 mt-10">
                    <div class="form_item_pass">
                        <label for="desp">描述</label>
                        <textarea id="desp" name="desp" class="flex-1" placeholder="请输入描述" rows="5"  value="<%- mdObj.desp %>"></textarea>
                    </div>
                </div>


                <div class="pure-u-1-2 form_item_pass mt-10">
                    <label for="time">时间</label>
                    <input id="time" type="date" name="time"  placeholder="2023-05-20"   value="<%- mdObj.time %>">
                </div>
                <div class="pure-u-1-2 form_item_pass mt-10">
                    <label for="type">分类</label>
                    <input id="type" name="type"  placeholder=""  readonly  value="<%- mdObj.type %>">
                </div>

                <div class="pure-u-1 form_item_pass mt-10">
                    <label for="tag">标签</label>
                    <input id="tag" name="tag"  placeholder="请输入描述"   value="<%- mdObj.tag %>">
                </div>

                <div class="pure-u-1 form_item_pass mt-10">
                    <label for="banner">封面</label>
                    <div class="upload-image-controller">
                        <input type="file" name="banner" id="banner" accept="image/*">
                        <img id="bannerShow" src="<%- mdObj.banner %>" alt="<%- mdObj.banner %>">
                    </div>
                </div>

                <div class="pure-u-1-2 form_item_pass mt-10">
                    <label for="recommend">是否推荐</label>
                    <jelly-switch id="recommend" name="recommend" <%- mdObj.recommend ? 'checked' : '' %>></jelly-switch>
                </div>



                <div class="pure-u-1-2 form_item_pass mt-10">
                    <label for="istop">是否置顶</label>
                    <jelly-switch id="istop" name="istop" <%- mdObj.istop ? 'checked' : '' %>></jelly-switch>
                </div>
            </div>







            <div id="editor" class="mt-20"></div>
            <button class="submit" type="submit">提交</button>
        </form>
    </section>

    <script src="js/editormd.min.js"></script>
<script>
    $(".type-li > a").click(function (ev) {
        $(this).parent().toggleClass("active")
        var next_li = $(this).parent().next()
        next_li.toggleClass("submenu-active")
    })
    $(".md-li > a").click(function (ev) {
        console.log(ev.currentTarget.dataset)
    })
    $(".add-type").click(function(ev) {
        ev.preventDefault()
        ev.stopPropagation()
        $("#typeForm").toggle()
        $("#parent").val(ev.currentTarget.dataset.type)

    })
    $("#typeForm .dialog-mask").click(function (ev) {
        ev.preventDefault()
        ev.stopPropagation()
        $("#typeForm").toggle()
    })
    var editor = editormd("editor", {
        width: "100%",
        height: "100%",
        markdown: `<% if(mdObj.content) { %><%-  mdObj.content.replace(/`/g, '\\`') %><%}%>`,     // dynamic set Markdown text
        path : "/lib/" , // Autoload modules mode, codemirror, marked... dependents libs path


        imageUpload    : true,
            imageFormats   : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
        imageUploadURL : "/api/admin/upload",

    });

    function img2Base64(input_file, get_data) {
        /*input_file：文件按钮对象*/
        /*get_data: 转换成功后执行的方法*/
        if (typeof (FileReader) === 'undefined') {
            console.log("图片异常")
        } else {
            try {
                /*图片转Base64 核心代码*/
                var file = input_file
                //这里我们判断下类型如果不是图片就返回 去掉就可以上传任意文件
                if (!/image\/\w+/.test(file.type)) {
                    console.log("图片img2base64：转化成功");
                    return false;
                }
                var reader = new FileReader();
                reader.onload = function () {
                    get_data(this.result);
                }
                reader.readAsDataURL(file);
            } catch (e) {
                console.log("图片img2base64：转化失败")
                console.log(local_message.E_CODE_0008 + e.toString());
            }
        }
    }

    $("#banner").change(function(ev) {
        const bannerFile = $(this)[0].files[0]
        img2Base64(bannerFile, function(data) {
            $("#bannerShow").attr("src", data)
        })
    })

</script>
</body>
</html>
